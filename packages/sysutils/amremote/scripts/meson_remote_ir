#!/bin/sh

if [ -f "/flash/dtb.img" ]; then
    DTB="/flash/dtb.img"
elif [ -f "/flash/meson64_odroidc2.dtb" ]; then
    DTB="/flash/meson64_odroidc2.dtb"
else
    exit 1
fi

remount() {
    if [ -f "$DTB" ]; then
        mount -o remount,"$1" /flash
    else
	exit 1
    fi
}

toggle_meson_remote() {
  if [ "$1" = "meson-remote" ];then
      DISABLE="/meson-ir/"
      ENABLE="/meson-remote/"
  elif [ "$1" = "meson-ir" ];then
      DISABLE="/meson-remote/"
      ENABLE="/meson-ir/"
  else
      exit 1
  fi
  if [ $(/usr/bin/fdtget -t s "$DTB" "$ENABLE" "status") = "disabled" ];then
      remount "rw"
      echo "Disabling $DISABLE in dtb"
      /usr/bin/fdtput -t s "$DTB" "$DISABLE" "status" "disabled"
      echo "Enabling $ENABLE in dtb"
      /usr/bin/fdtput -t s "$DTB" "$ENABLE" "status" "okay"
      echo "Warning: You need to reboot your system"
      remount "ro"
  fi
}

toggle_meson_remote "$1"

exit 0
